groups:
  - name: flexoraa_critical_alerts
    interval: 30s
    rules:
      - alert: HighAPILatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="flexoraa-api"}[5m])) by (le, route)) > 2
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "High API latency detected on {{ $labels.route }}"
          description: "p95 latency is {{ $value }}s (threshold: 2s)"
          runbook: "https://docs.flexoraa.com/runbooks/high-latency"
          
      - alert: HighWorkflowErrorRate
        expr: sum(rate(workflow_executions_total{status="error"}[5m])) / sum(rate(workflow_executions_total[5m])) * 100 > 5
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Workflow error rate exceeded 5%"
          description: "Current error rate: {{ $value | humanizePercentage }}"
          runbook: "https://docs.flexoraa.com/runbooks/workflow-errors"
          
      - alert: WhatsAppSendFailureSpike
        expr: sum(rate(whatsapp_send_failures_total[10m])) / sum(rate(whatsapp_send_total[10m])) * 100 > 2
        for: 10m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "WhatsApp send failure rate > 2%"
          description: "Failure rate: {{ $value | humanizePercentage }}"
          runbook: "https://docs.flexoraa.com/runbooks/whatsapp-failures"
          
      - alert: AITokenSpendSpike
        expr: rate(ai_tokens_used_total[1h]) > 2 * rate(ai_tokens_used_total[1h] offset 24h)
        for: 15m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "AI token spend increased >2x compared to yesterday"
          description: "Current rate: {{ $value }} tokens/hour"
          runbook: "https://docs.flexoraa.com/runbooks/ai-spend-spike"
          
  - name: flexoraa_capacity_alerts
    interval: 60s
    rules:
      - alert: HighDatabaseConnectionPoolUsage
        expr: pg_pool_active_connections / pg_pool_size > 0.8
        for: 10m
        labels:
          severity: warning
          team: infra
        annotations:
          summary: "Database connection pool usage > 80%"
          description: "{{ $value | humanizePercentage }} of pool in use"
          
      - alert: AssignmentQueueBacklog
        expr: assignment_queue_length{status="pending"} > 100
        for: 30m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Assignment queue backlog detected"
          description: "{{ $value }} pending assignments"
          
      - alert: ConsentOptOutSpike
        expr: sum(rate(consent_log_writes_total{consent_status="opt-out"}[5m])) * 300 > 10
        for: 5m
        labels:
          severity: warning
          team: compliance
        annotations:
          summary: "High opt-out rate detected"
          description: "{{ $value }} opt-outs in last 5 minutes"
          runbook: "https://docs.flexoraa.com/runbooks/opt-out-spike"
